# Задание 2

Задача: реализовать сервис пользователей с отметками проблем.

## Использованные технологии/библиотеки

- NestJS
- TypeORM
- Postgres

## Настройки

Настройка осуществляется с помощью переменных окружения:

| Переменная     | Описание                                  | Значение по умолчанию                               |
| -------------- | ----------------------------------------- | --------------------------------------------------- |
| `NODE_ENV`     | Окружение: `production` или `development` | `development`                                       |
| `PORT`         | Порт веб-сервера                          | `3000`                                              |
| `DATABASE_URL` | Строка подключения к базе данных          | `postgresql://postgres:postgres@localhost/em-users` |


## API

Все запросы имеют общий префикс `/api/v1`.

| Метод               | Запрос      | Ответ                  | Описание                                                                               |
| ------------------- | ----------- | ---------------------- | -------------------------------------------------------------------------------------- |
| `POST /users/reset` | Отсутствуют | `{ affected: number }` | Сбрасывает флаг проблемы и возвращает кол-во пользователей, имевших проблемы до сброса |

Примеры запросов: [requests.http](./requests.http).

## Особенности реализации

Поскольку в задании явно не сказано, что описывается структура БД, то принято решение оптимизировать структуру БД, выделив 2 отдельные сущности:

1. Пользователь: ИД, имя, фамилия, возраст, пол.
2. Проблема: ИД, пользователь.

Благодаря такому подходу сброс флага проблемы равносилен очистке таблицы с проблемами, что происходит очень быстро. При этом на внешнем интерфейсе ничего не мешает возвращать структуру данных в полем "проблемы" непосредственно в сущности пользователя - достаточно сделать объединение таблиц при запросе в БД.

Также было проведено тестирование времени выполнения запроса при разной структуре БД и индексов. Рассматривались следующие варианты:

1. Поле "проблемы" непосредственно в таблице пользователей. Без индекса.
2. Поле "проблемы" непосредственно в таблице пользователей. С индексом.
3. Поле "проблемы" непосредственно в таблице пользователей. С частичным индексом.
4. Отдельная таблица со списком пользователей с проблемами. Окончательный вариант.

Среднее время выполнения операции при использовании варианта 4 было в 20 раз меньше.

## Запуск

### Разработка

Запуск в режиме разработки выполняется следующими командами:

```shell
npm i
npm run start:dev
```

При этом выполняется автоматическая синхронизация структуры БД. Тестовые данные не загружаются.

### Docker

Полный набор сервисов можно запустить следующей командой:

```shell
docker-compose up -d
```

При этом будет выполнено создание структуры БД и заполнение ее тестовыми данными из миграций TypeORM.
