# Сервис товарных остатков

Реализует хранение справочника номенклатуры и остатков в разрезе торговых точек.

## Настройки

Настройка осуществляется с помощью переменных окружения:

| Переменная     | Описание                                       | Значение по умолчанию                                  |
| -------------- | ---------------------------------------------- | ------------------------------------------------------ |
| `NODE_ENV`     | Окружение: `production` или `development`      | `development`                                          |
| `PORT`         | Порт веб-сервера                               | `3000`                                                 |
| `DATABASE_URL` | Строка подключения к базе данных               | `postgresql://postgres:postgres@localhost/em-products` |
| `BROKER_URL`   | Строка подключения к брокеру сообщений (Redis) | `redis://localhost:6379/0`                             |
| `QUEUE_NAME`   | Имя очереди                                    | `products:events`                                      |

## Запуск

Предварительная установка зависимостей: `npm install`.

Запуск в режиме разработки с автоматическим перезапуском:  `npm run dev`.

Запуск в рабочем режиме:  `npm run start`.

## API

Все запросы имеют общий префикс `/api/v1`.

| Метод                   | Запрос                                                                                                                                                                                                         | Ответ                                                                                              | Описание                                                                                    |
| ----------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------- |
| `GET /products`         | Query-параметры: <br/> `plu` - фильтр по точному совпадению PLU <br/> `name` - поиск по частичному совпадению наименования                                                                                     | `{ "products": [{"plu": number, "name": string}] }`                                                | Получение товаров по фильтрам                                                               |
| `POST /products`        | Тело запроса: `{ "name": string }`                                                                                                                                                                             | `{ "product": { "plu": number, "name": string } }`                                                 | Создание товара, PLU генерируется автоматически                                             |
| `GET /stock`            | Query-параметры: <br/> `plu` - фильтр по PLU <br/> `shop_id` - фильтр по ИД торговой точки <br/> `shelf_gte`/`shelf_lte` - фильтр по кол-ву на полке <br/> `order_gte`/`order_lte` - фильтр по кол-ву в заказе | `{ "stock": [{"plu": number, "shop_id": number, "type": 'shelf'\|'order', "quantity": number }] }` | Получение остатков по фильтрам, фильтры по разным видам остатков объединяются условие "ИЛИ" |
| `PUT /stock`            | Тело запроса: `{plu: number, shop_id: number, stock: {shelf?: number, order?: number}}`                                                                                                                        | Пустой                                                                                             | Создание остатка                                                                            |
| `PATCH /stock/increase` | Тело зароса: `{plu: string, shop_id: string, delta: {shelf?: number, order?: number}`                                                                                                                          | Пустое                                                                                             | Увеличение остатка                                                                          |
| `PATCH /stock/decrease` | Тело зароса: `{plu: string, shop_id: string, delta: {shelf?: number, order?: number}`                                                                                                                          | Пустое                                                                                             | Уменьшение остатка                                                                          |

Примеры запросов: [requests.http](./requests.http).

## Особенности реализации

Поскольку задание описывает лишь высокоуровневые требования без уточнения многих моментов, то был принят ряд решений по моментам, не описанным в задании:

* инициализация БД выполняется самим сервисом при запуске;
* PLU геренируется сервисом автоматически;
* фильтры в запросе остатков комбинируются с условием "И" за исключением использования фильтров одновременно и по остаткам на полке, и по остаткам в заказе - они объединятся с условием "ИЛИ";
* запрос "создание остатка" работает в виде "заменить остаток" представляя собой операцию инвентаризации;
* операции увеличения и уменьшения остатка по своей сути идентичны, но выполнены разными запросами поскольку указаны отдельно в задании;
* для передачи событий в сервис истории действий используется очередь на основе списка Redis;
* события чтения данных не журналируются как малозначимые для аудита.
